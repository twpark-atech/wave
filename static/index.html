<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Atech Vision LLM (RealTime)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:#0b0f14; color:#e6eef8; }
    header { padding:12px 16px; display:flex; align-items:center; gap:12px; background:#0f1620; border-bottom:1px solid #1e2633;}
    header img.logo { height:36px; width:auto; display:block; }
    header .title { font-weight:700; font-size:20px; }
    .wrap { display:grid; grid-template-columns: 1fr 1fr; gap:16px; padding:16px; }
    .card { background:#0f1620; border:1px solid #1e2633; border-radius:12px; padding:12px; }
    video, canvas { width:100%; border-radius:8px; background:#000; }
    .row { display:flex; gap:8px; align-items:center; }
    .pill { padding:6px 10px; border:1px solid #263041; border-radius:999px; font-size:12px; color:#b9c6d4;}
    button { background:#1b2533; color:#e6eef8; border:1px solid #2b3647; padding:10px 14px; border-radius:8px; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    pre { white-space:pre-wrap; word-break:break-word; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color:#dbe7f6; }
    .muted { color:#8fa3b8; }
    input[type="text"] { flex:1; padding:10px 12px; border-radius:8px; border:1px solid #2b3647; background:#0b0f14; color:#e6eef8; }
  </style>
</head>
<body>
  <header>
    <img class="logo" src="/logo.png" alt="logo" />
    <div class="title">Atech Vision LLM</div>
  </header>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:8px;">
        <div class="pill">ì›¹ìº  ë¯¸ë¦¬ë³´ê¸°</div>
        <div class="row">
          <button id="btnStart">Start</button>
          <button id="btnStop" disabled>Stop</button>
        </div>
      </div>
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas" style="display:none;"></canvas>
      <div class="row" style="margin-top:8px; gap:16px;">
        <div class="pill"><span class="muted">í•´ìƒë„</span> <span id="res">-</span></div>
        <div class="pill"><span class="muted">ì¶”ë¡  ì§€ì—°</span> <span id="latency">-</span> ms</div>
        <div class="pill"><span class="muted">FPS(ì „ì†¡)</span> <span id="fps">-</span></div>
      </div>
      <div class="row" style="margin-top:12px;">
        <input id="txtQuery" type="text" placeholder="í…ìŠ¤íŠ¸ ì§ˆë¬¸ì„ ì…ë ¥í•˜ê³  Enterë¥¼ ëˆ„ë¥´ì„¸ìš”" />
        <button id="btnSendText">ë³´ë‚´ê¸°</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="btnMic" disabled>ğŸ™ï¸ ìŒì„± ì§ˆë¬¸(ëˆ„ë¥´ë©´ ë…¹ìŒ ì‹œì‘/ì¢…ë£Œ)</button>
        <span id="recStatus" class="muted">ëŒ€ê¸°</span>
      </div>
    </div>

    <div class="card">
      <div class="pill" style="margin-bottom:8px;">ì„¤ëª… ê²°ê³¼</div>
      <pre id="out">(ëŒ€ê¸° ì¤‘)</pre>
    </div>
  </div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const out = document.getElementById('out');
const res = document.getElementById('res');
const latency = document.getElementById('latency');
const fps = document.getElementById('fps');
const btnStart = document.getElementById('btnStart');
const btnStop = document.getElementById('btnStop');

const txtQuery = document.getElementById('txtQuery');
const btnSendText = document.getElementById('btnSendText');
const btnMic = document.getElementById('btnMic');
const recStatus = document.getElementById('recStatus');

let ws = null;
let stream = null;
let running = false;
let sent = 0, lastSec = 0;

// --- Audio recording state ---
let mediaRecorder = null;
let audioChunks = [];
let micStream = null;
let recording = false;

function dataURLFromCanvas() {
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  const W = 640;
  const H = Math.round(video.videoHeight * (W / video.videoWidth));
  canvas.width = W; canvas.height = H;
  ctx.drawImage(video, 0, 0, W, H);
  return canvas.toDataURL('image/webp', 0.85);
}

function wsSendJSON(obj) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify(obj));
  }
}

async function start() {
  if (running) return;
  running = true;
  btnStart.disabled = true;
  btnStop.disabled = false;

  stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
  video.srcObject = stream;

  ws = new WebSocket(`ws://${location.host}/ws`);
  ws.onopen = () => { btnMic.disabled = false; };
  ws.onmessage = (ev) => {
    try {
      const j = JSON.parse(ev.data);
      if ('latency_ms' in j) latency.textContent = j.latency_ms ?? '-';
      if ('explanation' in j) out.textContent = j.explanation || '(no text)';
    } catch(e) {
      // ignore parsing error
    }
  };
  ws.onclose = () => { stop(); };

  let lastTS = performance.now();
  const loop = () => {
    if (!running) return;
    const now = performance.now();
    if (now - lastTS > 500 && ws && ws.readyState === WebSocket.OPEN && video.videoWidth > 0) {
      const url = dataURLFromCanvas();
      // ì´ë¯¸ì§€ í”„ë ˆì„ ì „ì†¡ (ê¸°ì¡´: dataURLë§Œ ë³´ëƒˆë‹¤ë©´, ì´ì œ type ì§€ì •)
      wsSendJSON({ type: "frame", image: url });
      lastTS = now;
      sent++;
    }
    const sec = Math.floor(now / 1000);
    if (sec !== lastSec) {
      fps.textContent = sent.toString();
      sent = 0; lastSec = sec;
      if (video.videoWidth) res.textContent = `${video.videoWidth}Ã—${video.videoHeight}`;
    }
    requestAnimationFrame(loop);
  };
  requestAnimationFrame(loop);
}

function stop() {
  running = false;
  btnStart.disabled = false;
  btnStop.disabled = true;
  btnMic.disabled = true;

  if (ws && ws.readyState === WebSocket.OPEN) ws.close();
  ws = null;

  if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }

  // ë…¹ìŒ ì¤‘ì´ë©´ ì¤‘ë‹¨
  if (recording) stopRecording();

  fps.textContent = '-'; latency.textContent = '-'; res.textContent = '-';
  out.textContent = '(ëŒ€ê¸° ì¤‘)';
  recStatus.textContent = 'ëŒ€ê¸°';
}

// --- í…ìŠ¤íŠ¸ ì§ˆë¬¸ ì „ì†¡ ---
function sendText() {
  const q = txtQuery.value.trim();
  if (!q) return;
  wsSendJSON({ type: "text", user_query: q });
  // ì¦‰ì‹œ ë°˜ì˜ë˜ë„ë¡ ì…ë ¥ì°½ ì´ˆê¸°í™”(ì„ í˜¸ì— ë”°ë¼ ìœ ì§€ ê°€ëŠ¥)
  // txtQuery.value = "";
}
btnSendText.onclick = sendText;
txtQuery.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') { e.preventDefault(); sendText(); }
});

// --- ìŒì„± ë…¹ìŒ í† ê¸€ ---
async function toggleMic() {
  if (!recording) {
    // start recording
    try {
      micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch (e) {
      recStatus.textContent = 'ë§ˆì´í¬ ê¶Œí•œ ê±°ë¶€ë¨';
      return;
    }
    mediaRecorder = new MediaRecorder(micStream, { mimeType: "audio/webm" });
    audioChunks = [];
    mediaRecorder.ondataavailable = (e) => {
      if (e.data && e.data.size > 0) audioChunks.push(e.data);
    };
    mediaRecorder.onstop = async () => {
      const blob = new Blob(audioChunks, { type: "audio/webm" });
      const buf = await blob.arrayBuffer();
      const base64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
      // ì˜¤ë””ì˜¤ ì „ì†¡ (ì„œë²„ëŠ” base64 ë””ì½”ë“œ í›„ STT ë“± ì²˜ë¦¬)
      wsSendJSON({ type: "audio", mime: "audio/webm", data: base64 });
      // ì •ë¦¬
      micStream.getTracks().forEach(t => t.stop());
      micStream = null;
      audioChunks = [];
    };
    mediaRecorder.start();
    recording = true;
    recStatus.textContent = 'ë…¹ìŒ ì¤‘â€¦ (ë²„íŠ¼ ë‹¤ì‹œ ëˆ„ë¥´ë©´ ì „ì†¡)';
    btnMic.textContent = 'ğŸ›‘ ë…¹ìŒ ì¢…ë£Œ/ì „ì†¡';
  } else {
    // stop recording
    recording = false;
    recStatus.textContent = 'ì¸ì½”ë”©/ì „ì†¡ ì¤‘â€¦';
    btnMic.textContent = 'ğŸ™ï¸ ìŒì„± ì§ˆë¬¸(ëˆ„ë¥´ë©´ ë…¹ìŒ ì‹œì‘/ì¢…ë£Œ)';
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
      mediaRecorder.stop();
    }
  }
}
btnMic.onclick = toggleMic;

btnStart.onclick = start;
btnStop.onclick = stop;
</script>
</body>
</html>
